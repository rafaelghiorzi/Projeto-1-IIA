{% extends 'base.html' %}

{% block content %}
<h1>Produtores Locais</h1>

<form method="get">
    <div>
        <h3>Filtros:</h3>
        <button type="submit" name="filtro" value="todos">Todos</button>
        <button type="submit" name="filtro" value="sazonal">Sazonal</button>
        <button type="submit" name="filtro" value="top">Melhores Avaliados</button>
        
        <h4>Produtos:</h4>
        {% for produto in produtos %}
            <label>
                <input type="checkbox" name="produtos" value="{{ produto.nome }}">
                {{ produto.nome }}
            </label>
        {% endfor %}
    </div>
    
    <div>
        <h4>Localização:</h4>
        <button type="button" onclick="getLocation()">Usar minha localização</button>
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
    </div>
</form>

<div class="map-container">
    <div id="map"></div>
</div>

<div class="produtores-list">
    {% for produtor in produtores %}
        <div class="produtor-card">
            <h3><a href="{% url 'detalhes_produtor' produtor.id %}">{{ produtor.nome }}</a></h3>
            <p>Produtos: 
                {% for produto in produtor.produtos.all %}
                    {{ produto.nome }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
    {% endfor %}
</div>

<script>
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
    }
    
    function showPosition(position) {
        document.getElementById('latitude').value = position.coords.latitude;
        document.getElementById('longitude').value = position.coords.longitude;
        document.forms[0].submit();
    }
    
    // Mapa
    var map = L.map('map').setView([-15.78, -47.93], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    {% for produtor in produtores %}
        L.marker([{{ produtor.lat }}, {{ produtor.lon }}]).addTo(map)
            .bindPopup("<a href='{% url 'detalhes_produtor' produtor.id %}'>{{ produtor.nome }}</a>");
    {% endfor %}
</script>
{% endblock %}